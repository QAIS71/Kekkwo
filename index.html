import React, { useState, useRef } from 'react';
import { Camera, Download, RefreshCcw, Rocket, Share2, Stars, Zap, Eye } from 'lucide-react';

const App = () => {
  const [userImage, setUserImage] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [finalResult, setFinalResult] = useState(null);
  const canvasRef = useRef(null);

  // استخدام الصورة الأصلية التي أرسلتها كقاعدة ثابتة
  const BASE_IMAGE = "https://i.ibb.co/L5fX0N5/1767511487529-2.jpg"; 

  const handleUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => setUserImage(ev.target.result);
      reader.readAsDataURL(file);
    }
  };

  const processImage = () => {
    if (!userImage) return;
    setIsProcessing(true);

    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const bg = new Image();
    const user = new Image();

    bg.crossOrigin = "anonymous";
    bg.src = BASE_IMAGE;
    user.src = userImage;

    bg.onload = () => {
      canvas.width = bg.width;
      canvas.height = bg.height;

      // 1. رسم المشهد الأصلي (المحطة من الداخل)
      ctx.drawImage(bg, 0, 0);

      // 2. تحديد منطقة الشاشة (التابلت) في صورتك بدقة
      const x = canvas.width * 0.428; 
      const y = canvas.height * 0.355;
      const w = canvas.width * 0.155; 
      const h = canvas.height * 0.165;

      ctx.save();
      // قص الحواف لتناسب إطار الشاشة
      ctx.beginPath();
      ctx.rect(x, y, w, h);
      ctx.clip();

      // 3. معالجة صورة المستخدم لتبدو "إلكترونية"
      // رسم الصورة
      const scale = Math.max(w / user.width, h / user.height);
      const sw = user.width * scale;
      const sh = user.height * scale;
      const sx = x + (w - sw) / 2;
      const sy = y + (h - sh) / 2;
      
      ctx.drawImage(user, sx, sy, sw, sh);

      // إضافة "فلتر" إضاءة المحطة (أزرق/أخضر تقني)
      ctx.fillStyle = "rgba(0, 255, 255, 0.15)";
      ctx.globalCompositeOperation = "screen";
      ctx.fillRect(x, y, w, h);
      ctx.globalCompositeOperation = "source-over";

      // إضافة خطوط المسح (Scanlines) لتبدو كشاشة حقيقية
      ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
      ctx.lineWidth = 1;
      for(let i = y; i < y+h; i+=3) {
        ctx.beginPath();
        ctx.moveTo(x, i);
        ctx.lineTo(x+w, i);
        ctx.stroke();
      }

      // 4. الانعكاس الزجاجي العلوي (ليظهر وكأنه زجاج المقصورة)
      const gradient = ctx.createLinearGradient(x, y, x + w, y + h);
      gradient.addColorStop(0, "rgba(255, 255, 255, 0.25)");
      gradient.addColorStop(0.4, "rgba(255, 255, 255, 0)");
      gradient.addColorStop(0.6, "rgba(255, 255, 255, 0)");
      gradient.addColorStop(1, "rgba(255, 255, 255, 0.1)");
      ctx.fillStyle = gradient;
      ctx.fillRect(x, y, w, h);

      ctx.restore();

      // 5. إضافة لمسة نهائية: وهج بسيط حول الشاشة
      ctx.shadowBlur = 15;
      ctx.shadowColor = "rgba(0, 255, 255, 0.5)";
      ctx.strokeStyle = "rgba(0, 255, 255, 0.3)";
      ctx.strokeRect(x, y, w, h);

      setTimeout(() => {
        setFinalResult(canvas.toDataURL("image/png"));
        setIsProcessing(false);
      }, 1500);
    };
  };

  return (
    <div className="min-h-screen bg-[#030508] text-white font-sans selection:bg-blue-500">
      {/* Navbar */}
      <nav className="p-4 border-b border-white/5 flex justify-between items-center bg-black/80 backdrop-blur-xl sticky top-0 z-50">
        <div className="flex items-center gap-2">
          <div className="bg-blue-600 p-1.5 rounded-lg shadow-lg shadow-blue-600/20">
            <Rocket size={20} className="text-white" />
          </div>
          <span className="font-black text-lg tracking-tighter italic">ISS_INTERIOR_v2</span>
        </div>
        <div className="hidden md:flex gap-6 text-[11px] font-bold uppercase tracking-widest text-gray-400">
          <span className="text-blue-400">الرئيسية</span>
          <span>المعرض</span>
          <span>الخصوصية</span>
        </div>
      </nav>

      <main className="max-w-6xl mx-auto p-6 grid lg:grid-cols-2 gap-12 mt-4 items-center">
        
        {/* Left Side: Upload */}
        <div className="space-y-8 animate-in fade-in slide-in-from-left-4 duration-700">
          <div className="space-y-3">
            <h1 className="text-4xl md:text-5xl font-black leading-none bg-gradient-to-br from-white to-gray-500 bg-clip-text text-transparent">
              سيلفي داخل المحطة الفضائية
            </h1>
            <p className="text-gray-400 text-sm md:text-base leading-relaxed max-w-md">
              حول صورتك إلى بث مباشر يظهر داخل أجهزة محطة الفضاء الدولية. الموقع يستخدم صورتك الأصلية للحفاظ على الواقعية الكاملة.
            </p>
          </div>

          <div className="bg-[#0a0c12] border border-white/10 p-6 rounded-[2rem] shadow-2xl relative overflow-hidden group">
            <div className="absolute -top-24 -right-24 w-48 h-48 bg-blue-600/10 rounded-full blur-3xl group-hover:bg-blue-600/20 transition-all duration-700"></div>
            
            <div className="relative space-y-6">
              <label className="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-white/10 rounded-3xl cursor-pointer hover:border-blue-500/50 hover:bg-blue-500/5 transition-all overflow-hidden bg-black/40 group">
                {userImage ? (
                  <img src={userImage} className="w-full h-full object-cover animate-in zoom-in duration-300" alt="Preview" />
                ) : (
                  <div className="text-center space-y-4">
                    <div className="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto ring-1 ring-white/10 group-hover:ring-blue-500/50 transition-all">
                      <Camera className="text-gray-500 group-hover:text-blue-400" size={28} />
                    </div>
                    <div>
                      <p className="text-sm font-bold text-gray-300">ارفع صورتك الشخصية</p>
                      <p className="text-[10px] text-gray-500 mt-1">تتم المعالجة داخل جهازك فقط</p>
                    </div>
                  </div>
                )}
                <input type="file" className="hidden" onChange={handleUpload} accept="image/*" />
              </label>

              <button 
                onClick={processImage}
                disabled={!userImage || isProcessing}
                className="w-full py-4 bg-blue-600 hover:bg-blue-500 disabled:opacity-20 text-white font-black rounded-2xl shadow-xl shadow-blue-900/40 transition-all flex items-center justify-center gap-3 active:scale-95 group"
              >
                {isProcessing ? <RefreshCw className="animate-spin" /> : <Zap size={18} className="group-hover:animate-pulse" />}
                {isProcessing ? "جاري البث للمحطة..." : "تحديث شاشة المقصورة"}
              </button>
            </div>
          </div>

          {/* Ad Space Top */}
          <div className="w-full py-4 px-6 bg-white/5 border border-dashed border-white/10 rounded-2xl flex items-center justify-between">
            <span className="text-[10px] font-bold text-gray-600 uppercase tracking-widest">مساحة إعلانية</span>
            <div className="w-24 h-4 bg-white/10 rounded animate-pulse"></div>
          </div>
        </div>

        {/* Right Side: Preview */}
        <div className="relative flex flex-col gap-6 animate-in fade-in slide-in-from-right-4 duration-700">
          <div className="relative bg-black rounded-[2.5rem] overflow-hidden border border-white/10 shadow-[0_0_100px_rgba(0,0,0,0.8)] group aspect-[4/3]">
            {finalResult ? (
              <img src={finalResult} className="w-full h-full object-cover animate-in fade-in zoom-in duration-1000" alt="Result" />
            ) : (
              <div className="w-full h-full flex flex-col items-center justify-center p-12 text-center bg-[#05070a]">
                <div className="relative mb-6">
                  <div className="w-20 h-20 border-2 border-white/5 border-t-blue-500 rounded-full animate-spin"></div>
                  <Eye className="absolute inset-0 m-auto text-blue-500/20" size={24} />
                </div>
                <h3 className="text-lg font-bold text-gray-500">جاهز للمعاينة</h3>
                <p className="text-gray-700 text-xs mt-2">صورتك ستظهر داخل الشاشة تماماً كما في مشهد المحطة الأصلي</p>
              </div>
            )}
            
            {/* Overlay UI elements */}
            <div className="absolute top-6 left-6 flex items-center gap-2 bg-black/40 backdrop-blur-md px-3 py-1.5 rounded-full border border-white/10">
              <div className="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>
              <span className="text-[9px] font-bold tracking-widest">REC: ISS_CAM_01</span>
            </div>
          </div>

          {finalResult && (
            <div className="flex gap-4">
              <a 
                href={finalResult} 
                download="space-interior-selfie.png"
                className="flex-1 bg-white text-black font-black py-4 rounded-2xl flex items-center justify-center gap-2 hover:bg-blue-400 transition-all shadow-xl active:scale-95"
              >
                <Download size={18} /> تحميل الصورة
              </a>
              <button className="bg-white/5 p-4 rounded-2xl border border-white/10 hover:bg-white/10 transition active:scale-95">
                <Share2 size={22} className="text-gray-400" />
              </button>
            </div>
          )}

          {/* Ad Space Side */}
          <div className="w-full min-h-[120px] bg-white/5 border border-dashed border-white/10 rounded-[2rem] flex items-center justify-center text-[10px] text-gray-700 font-bold uppercase tracking-widest">
            إعلان Google AdSense هنا
          </div>
        </div>
      </main>

      <footer className="mt-20 border-t border-white/5 py-12 px-6 flex flex-col md:flex-row justify-between items-center max-w-6xl mx-auto gap-6 text-gray-600">
        <div className="flex items-center gap-4 text-[10px] font-bold uppercase tracking-widest">
          <span className="hover:text-blue-400 cursor-pointer transition">عن المشروع</span>
          <span className="hover:text-blue-400 cursor-pointer transition">تواصل معنا</span>
          <span className="hover:text-blue-400 cursor-pointer transition">الشروط</span>
        </div>
        <p className="text-[10px] font-medium opacity-50 italic">© 2024 سيلفي الفضاء - جودة المحاكاة الفضائية</p>
      </footer>

      <canvas ref={canvasRef} className="hidden" />
    </div>
  );
};

export default App;

